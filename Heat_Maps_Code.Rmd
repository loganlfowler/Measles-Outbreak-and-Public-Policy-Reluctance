---
title: "Measles Outbreak & Public Policy Reluctance"
author: "Logan Fowler"
date: "2025-09-30"
output: html_document
---

```{r}
measles <- read_csv("measles_county_all_updates.csv") %>%
  clean_names()

cov_wide <- read_csv("mmr_data_us_counties.csv") %>%
  mutate(FIPS = str_pad(as.character(FIPS), 5, pad = "0"))
```

```{r}
#aggregate data
year_to_map <- 2025
measles_cnty <- measles %>%
  filter(location_type == "county") %>%
  mutate(date = ymd(date),
         fips = str_pad(as.character(location_id), 5, pad = "0")) %>%
  filter(year(date) == year_to_map,
         outcome_type %in% c("case_lab-confirmed", "case_probable")) %>%
  group_by(fips) %>%
  summarize(cases = sum(value, na.rm = TRUE), .groups = "drop")

#county shapes
counties_sf <- tigris::counties(cb = TRUE, year = 2023) %>%
  filter(!STATEFP %in% c("60", "66", "69", "72", "78")) %>%  
  tigris::shift_geometry() %>%   
  select(GEOID, NAME, STATEFP, geometry) %>%
  st_transform(5070)

#outbreak map
county_centroids <- st_centroid(counties_sf) %>%
  select(GEOID)
case_points <- county_centroids %>%
  left_join(measles_cnty, by = c("GEOID" = "fips")) %>%
  filter(!is.na(cases) & cases > 0)

#coverage prep
cov_wide <- readr::read_csv("mmr_data_us_counties.csv") %>%
  dplyr::mutate(FIPS = stringr::str_pad(as.character(FIPS), 5, pad = "0"))

cov_long <- cov_wide %>%
  tidyr::pivot_longer(
    tidyselect::starts_with("SY"),
    names_to  = "school_year",
    values_to = "mmr_coverage",
    values_transform = list(mmr_coverage = as.character)
  ) %>%
  dplyr::mutate(
    mmr_coverage = readr::parse_number(mmr_coverage),
    mmr_coverage = dplyr::if_else(mmr_coverage > 1, mmr_coverage/100, mmr_coverage),
    year_start   = as.integer(stringr::str_sub(school_year, 3, 6))
  )

cov_cf <- cov_long %>%
  group_by(FIPS) %>%
  complete(year_start = seq(min(year_start, na.rm = TRUE),
                            max(year_start, na.rm = TRUE))) %>%
  arrange(year_start) %>%
  fill(mmr_coverage, .direction = "downup") %>%
  ungroup()

###

cov_for_map <- cov_cf %>%
  group_by(FIPS) %>%
  arrange(year_start, .by_group = TRUE) %>%
  slice_tail(n = 1) %>%              
  ungroup() %>%
  mutate(FIPS = stringr::str_pad(FIPS, 5, pad = "0")) %>%
  select(fips = FIPS, coverage = mmr_coverage)

counties_cov <- counties_sf %>%
  left_join(cov_for_map %>% rename(GEOID = fips), by = "GEOID")

###

ggplot() +
  geom_sf(data = counties_cov,
          aes(fill = coverage * 100), color = NA) +  
  geom_sf(data = case_points,
          aes(size = cases),
          shape = 21, fill = NA, color = "white", alpha = 0.85) +
  scale_fill_gradientn(
  colours = c("#fde0dd", "#fa9fb5", "#c51b8a", "#7a0177", "black"),
  na.value = "#f5deb3",  
  limits = c(70, 100),
  oob = scales::squish,
  breaks = c(80, 85, 90, 95, 100),
  name = "MMR coverage (%)"
  ) +
  scale_size_area(max_size = 7, name = "Measles cases") +
  coord_sf() +
  labs(
    title = paste("County MMR Coverage & Measles Outbreaks")
  ) +
  theme_void(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))
```

```{r}
measles <- readr::read_csv("measles_county_all_updates.csv") %>% clean_names()

year_to_map <- 2025

measles_cnty <- measles %>%
  filter(location_type == "county") %>%
  mutate(date = ymd(date),
         fips = str_pad(as.character(location_id), 5, pad = "0")) %>%
  filter(year(date) == year_to_map,
         outcome_type %in% c("case_lab-confirmed", "case_probable")) %>%
  group_by(fips) %>%
  summarize(cases = sum(value, na.rm = TRUE), .groups = "drop")

#county shapes
counties_sf <- tigris::counties(cb = TRUE, year = 2023) %>%
  filter(!STATEFP %in% c("60", "66", "69", "72", "78")) %>%  
  tigris::shift_geometry() %>%  
  select(GEOID, NAME, STATEFP, geometry) %>%
  st_transform(5070)

#outbreak map
county_centroids <- st_centroid(counties_sf) %>% select(GEOID)
case_points <- county_centroids %>%
  left_join(measles_cnty, by = c("GEOID" = "fips")) %>%
  filter(!is.na(cases) & cases > 0)

#partisanship prep
elex <- readr::read_csv("countypres_2000-2024.csv", show_col_types = FALSE) %>%
  mutate(fips = str_pad(as.character(county_fips), 5, pad = "0"))

latest_year <- max(elex$year, na.rm = TRUE)

partisan_cnty <- elex %>%
  filter(year == latest_year, party %in% c("DEMOCRAT","REPUBLICAN")) %>%
  group_by(fips) %>%
  summarize(
    dem = sum(candidatevotes[party == "DEMOCRAT"], na.rm = TRUE),
    rep = sum(candidatevotes[party == "REPUBLICAN"], na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    twoparty  = dem + rep,
    dem_share = if_else(twoparty > 0, dem / twoparty, NA_real_),
    rep_share = if_else(twoparty > 0, rep / twoparty, NA_real_),
    margin_pp = 100 * (dem_share - rep_share)  
  )

counties_partisan <- counties_sf %>%
  left_join(partisan_cnty, by = c("GEOID" = "fips"))

#plot
ggplot() +
  geom_sf(data = counties_partisan, aes(fill = margin_pp), color = NA) +

  geom_sf(data = case_points,
          aes(size = cases),
          shape = 21, fill = NA, color = "black", stroke = 0.7) +

  scale_fill_gradient2(
    low = "#cb181d", mid = "white", high = "#2b8cbe",
    midpoint = 0, limits = c(-60, 60),               
    name = paste0("+ = Dem, \u2212 = Rep"),
    na.value = "#f5deb3"                             
  ) +
  scale_size_area(max_size = 7, name = "Measles cases") +
  coord_sf() +
  labs(
    title = paste0("County Presidential Vote (", latest_year, ") & Measles Outbreaks")
  ) +
  theme_void(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))
```

```{r}
year_to_map <- 2025

measles_cnty <- measles %>%
  filter(location_type == "county") %>%
  mutate(date = ymd(date),
         fips = str_pad(as.character(location_id), 5, pad = "0")) %>%
  filter(year(date) == year_to_map,
         outcome_type %in% c("case_lab-confirmed", "case_probable")) %>%
  group_by(fips) %>%
  summarize(cases = sum(value, na.rm = TRUE), .groups = "drop")

#county shapes
counties_sf <- tigris::counties(cb = TRUE, year = 2023) %>%
  filter(!STATEFP %in% c("60","66","69","72","78")) %>%  
  tigris::shift_geometry() %>%
  select(GEOID, NAME, STATEFP, geometry) %>%
  st_transform(5070)

#outbreak map
county_centroids <- st_centroid(counties_sf) %>% select(GEOID)

case_points <- county_centroids %>%
  left_join(measles_cnty, by = c("GEOID" = "fips")) %>%
  filter(!is.na(cases) & cases > 0)


#covid vaccine hesitancy prep
covid_hes <- readr::read_csv(
  "Vaccine_Hesitancy_for_COVID-19__County_and_local_estimates_20251107.csv",
  show_col_types = FALSE
) %>%
  mutate(
    fips = str_pad(as.character(`FIPS Code`), 5, pad = "0"),
    est_hesitant = readr::parse_number(`Estimated hesitant`),
    est_hesitant = if_else(est_hesitant <= 1, est_hesitant * 100, est_hesitant)
  ) %>%
  select(fips, est_hesitant)


counties_hes <- counties_sf %>%
  left_join(covid_hes %>% rename(GEOID = fips), by = "GEOID")

#plot
ggplot() +
  geom_sf(
    data = counties_hes,
    aes(fill = est_hesitant),
    color = NA
  ) +
  geom_sf(
    data = case_points,
    aes(size = cases),
    shape = 21, fill = NA, color = "black", alpha = 0.7
  ) +
  scale_fill_gradientn(
    colours = c("#f7fbff", "#c6dbef", "#6baed6", "#2171b5", "#08306b"),
    na.value = "#f5deb3",
    limits = c(0, 30),           
    oob = scales::squish,
    breaks = c(5, 10, 15, 20, 25, 30, 35, 40),
    name = "Estimated hesitant (%)"
  ) +
  scale_size_area(max_size = 7, name = "Measles cases") +
  coord_sf() +
  labs(
    title   = "County COVID-19 Vaccine Hesitancy (2021) & Measles Outbreaks") +
  theme_void(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))
```

```{r}
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(ggplot2)
library(sf)
library(tigris)
library(lubridate)

options(tigris_class = "sf")


year_to_map <- 2025

measles_cnty <- measles %>%
  filter(location_type == "county") %>%
  mutate(
    date = ymd(date),
    fips = str_pad(as.character(location_id), 5, pad = "0")
  ) %>%
  filter(
    year(date) == year_to_map,
    outcome_type %in% c("case_lab-confirmed", "case_probable")
  ) %>%
  group_by(fips) %>%
  summarize(cases = sum(value, na.rm = TRUE), .groups = "drop")

#county shapes
counties_sf <- tigris::counties(cb = TRUE, year = 2023) %>%
  filter(!STATEFP %in% c("60", "66", "69", "72", "78")) %>%
  tigris::shift_geometry() %>%
  select(GEOID, NAME, STATEFP, geometry) %>%
  st_transform(5070)


data("fips_codes", package = "tigris")  

state_lookup <- fips_codes %>%
  select(state_code = state_code, state = state, state_name = state_name) %>%
  distinct()

counties_sf <- counties_sf %>%
  left_join(state_lookup, by = c("STATEFP" = "state_code")) %>%
  mutate(
    merge_name  = NAME,        
    merge_state = state        
  )

#covid coverage prep
covid_raw <- readr::read_csv("Covid-Coverage.csv")

covid_cov <- covid_raw %>%
  mutate(
    merge_state = state.abb[match(State, state.name)],   
    merge_name  = str_remove(Area, " County") %>% str_trim(),
    coverage    = parse_number(`Percentage of people fully vaccinated`),
    coverage    = if_else(coverage > 1, coverage / 100, coverage)
  ) %>%
  select(merge_state, merge_name, coverage)


counties_cov <- counties_sf %>%
  left_join(covid_cov, by = c("merge_state", "merge_name"))

county_centroids <- st_centroid(counties_sf) %>% select(GEOID)

case_points <- county_centroids %>%
  left_join(measles_cnty, by = c("GEOID" = "fips")) %>%
  filter(!is.na(cases) & cases > 0)

#plot
ggplot() +
  geom_sf(
    data = counties_cov,
    aes(fill = coverage * 100),
    color = NA
  ) +
  geom_sf(
    data = case_points,
    aes(size = cases),
    shape = 21,
    fill = NA,
    color = "white",
    alpha = 0.85
  ) +
  scale_fill_gradientn(
    colours = c("#e5f5e0", "#74c476", "#238b45", "#00441b", "black"),
    na.value = "#f5deb3",
    limits = c(20, 100),
    oob = scales::squish,
    breaks = c(20, 40, 60, 80, 100),
    name = "COVID full vaccination (%)"
  ) +
  scale_size_area(max_size = 7, name = "Measles cases") +
  coord_sf() +
  labs(
    title = "COVID-19 Vaccination Coverage & Measles Outbreaks"
  ) +
  theme_void(base_size = 12) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5))
```
