---
title: "measles_insurance_analysis"
author: "Miriam Zhou"
date: "2025-09-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(lmtest)
library(ggrepel)
library(sandwich)
library(tidyverse)
library(ggcorrplot)
library(ggpubr)
```


```{r insured vs. measles across counties load in}
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)

tx_measles <- read.csv("data/texas_measles.csv")

tx_measles_long <- pivot_longer(
  tx_measles,
  cols = starts_with("X"),
  names_to = "Year",
  values_to = "Measles_Cases"
)

tx_measles_long$Year <- as.numeric(str_extract(tx_measles_long$Year, "\\d+"))
tx_measles_long$County <- str_to_lower(str_trim(tx_measles_long$County))
tx_measles_long$County <- str_remove(tx_measles_long$County, " county")

# ---- 2. Load Each Year Individually ----
chr_2014 <- read_csv("data/analytic_data2014.csv", skip = 1, show_col_types = FALSE)
chr_2015 <- read_csv("data/analytic_data2015.csv", skip = 1, show_col_types = FALSE)
chr_2016 <- read_csv("data/analytic_data2016.csv", skip = 1, show_col_types = FALSE)
chr_2017 <- read_csv("data/analytic_data2017.csv", skip = 1, show_col_types = FALSE)
chr_2018 <- read_csv("data/analytic_data2018_0.csv", skip = 1, show_col_types = FALSE)
chr_2019 <- read_csv("data/analytic_data2019.csv", skip = 1, show_col_types = FALSE)
chr_2020 <- read_csv("data/analytic_data2020_0.csv", skip = 1, show_col_types = FALSE)
chr_2021 <- read_csv("data/analytic_data2021.csv", skip = 1, show_col_types = FALSE)
chr_2022 <- read_csv("data/analytic_data2022.csv", skip = 1, show_col_types = FALSE)
chr_2023 <- read_csv("data/analytic_data2023_0.csv", skip = 1, show_col_types = FALSE)
chr_2024 <- read_csv("data/analytic_data2024.csv", skip = 1, show_col_types = FALSE)

extract_texas_data <- function(df, year) {
  names(df) <- tolower(names(df))
  if (!"state" %in% names(df)) return(NULL)
  df_tx <- df[df$state == "TX", ]
  
  vars <- c("state", "county", "v085_rawvalue", "v003_rawvalue", "v122_rawvalue", "v051_rawvalue")
  vars <- vars[vars %in% names(df_tx)]
  
  df_tx <- df_tx[, vars]
  df_tx$Year <- year
  
  if ("county" %in% names(df_tx)) {
    df_tx$county <- str_to_lower(str_trim(df_tx$county))
    df_tx$county <- str_remove(df_tx$county, " county")
  }
  
  names(df_tx)[names(df_tx) == "state"] <- "State"
  names(df_tx)[names(df_tx) == "county"] <- "County"
  names(df_tx)[names(df_tx) == "v085_rawvalue"] <- "Uninsured_All"
  names(df_tx)[names(df_tx) == "v003_rawvalue"] <- "Uninsured_Adults"
  names(df_tx)[names(df_tx) == "v122_rawvalue"] <- "Uninsured_Children"
  names(df_tx)[names(df_tx) == "v051_rawvalue"] <- "Population"
  
  return(df_tx)
}

years <- 2014:2024
chr_tx_panel <- rbind(
  extract_texas_data(chr_2014, 2014),
  extract_texas_data(chr_2015, 2015),
  extract_texas_data(chr_2016, 2016),
  extract_texas_data(chr_2017, 2017),
  extract_texas_data(chr_2018, 2018),
  extract_texas_data(chr_2019, 2019),
  extract_texas_data(chr_2020, 2020),
  extract_texas_data(chr_2021, 2021),
  extract_texas_data(chr_2022, 2022),
  extract_texas_data(chr_2023, 2023),
  extract_texas_data(chr_2024, 2024)
)

panel <- merge(chr_tx_panel, tx_measles_long, by = c("County", "Year"), all.x = TRUE)

panel$Uninsured_All <- as.numeric(panel$Uninsured_All)
panel$Uninsured_Adults <- as.numeric(panel$Uninsured_Adults)
panel$Uninsured_Children <- as.numeric(panel$Uninsured_Children)
panel$Population <- as.numeric(panel$Population)
panel$Measles_Cases <- as.numeric(panel$Measles_Cases)
```

```{r insured vs. measles plots}
year_to_plot <- 2019

panel_year <- panel[panel$Year == year_to_plot, ]

ggplot(panel_year, aes(x = Uninsured_All, y = Measles_Cases)) +
  geom_point(alpha = 0.7, color = "firebrick") +
  geom_smooth(method = "lm", color = "steelblue", se = FALSE) +
  labs(
    title = paste("Texas Counties:", year_to_plot, "Measles Cases vs % Uninsured"),
    x = "% Uninsured (All Ages)",
    y = "Measles Cases"
  ) +
  theme_minimal(base_size = 13)

ggplot(panel, aes(x = Uninsured_All, y = Measles_Cases)) +
  geom_point(alpha = 0.6, color = "firebrick") +
  geom_smooth(method = "lm", color = "steelblue", se = FALSE) +
  facet_wrap(~Year, ncol = 4) +
  labs(
    title = "Texas Counties: Measles Cases vs % Uninsured (All Ages, 2014–2024)",
    x = "% Uninsured (All Ages)",
    y = "Measles Cases"
  ) +
  theme_minimal(base_size = 13)

# Adults
ggplot(panel, aes(x = Uninsured_Adults, y = Measles_Cases)) +
  geom_point(alpha = 0.6, color = "darkorange3") +
  geom_smooth(method = "lm", color = "steelblue", se = FALSE) +
  facet_wrap(~Year, ncol = 4) +
  labs(
    title = "Texas Counties: Measles Cases vs % Uninsured (Adults 18–64, 2014–2024)",
    x = "% Uninsured (Adults 18–64)",
    y = "Measles Cases"
  ) +
  theme_minimal(base_size = 13)

# Children
ggplot(panel, aes(x = Uninsured_Children, y = Measles_Cases)) +
  geom_point(alpha = 0.6, color = "forestgreen") +
  geom_smooth(method = "lm", color = "steelblue", se = FALSE) +
  facet_wrap(~Year, ncol = 4) +
  labs(
    title = "Texas Counties: Measles Cases vs % Uninsured (Children <18, 2014–2024)",
    x = "% Uninsured (Children <18)",
    y = "Measles Cases"
  ) +
  theme_minimal(base_size = 13)

```

```{r insureance analysis cleanup}
library(readr)
library(dplyr)
library(janitor)

raw <- read_csv("texas 2016-2024.csv", col_names = FALSE)
new_headers <- c(
  "texas_year",
  "characteristic",
  "total_number",
  "total_margin_of_error",
  "covered_by_any_health_insurance_number",
  "covered_by_any_health_insurance_margin_of_error",
  "covered_by_any_health_insurance_percent",
  "covered_by_any_health_insurance_margin_of_error_2",
  "covered_by_private_health_insurance_number",
  "covered_by_private_health_insurance_margin_of_error",
  "covered_by_private_health_insurance_percent",
  "covered_by_private_health_insurance_margin_of_error_2",
  "covered_by_private_health_insurance_employment_based_number",
  "covered_by_private_health_insurance_employment_based_margin_of_error",
  "covered_by_private_health_insurance_employment_based_percent",
  "covered_by_private_health_insurance_employment_based_margin_of_error_2",
  "covered_by_private_health_insurance_direct_purchase_number",
  "covered_by_private_health_insurance_direct_purchase_margin_of_error",
  "covered_by_private_health_insurance_direct_purchase_percent",
  "covered_by_private_health_insurance_direct_purchase_margin_of_error_2",
  "covered_by_private_health_insurance_tricare_number",
  "covered_by_private_health_insurance_tricare_margin_of_error",
  "covered_by_private_health_insurance_tricare_percent",
  "covered_by_private_health_insurance_tricare_margin_of_error_2",
  "covered_by_government_health_insurance_number",
  "covered_by_government_health_insurance_margin_of_error",
  "covered_by_government_health_insurance_percent",
  "covered_by_government_health_insurance_margin_of_error_2",
  "covered_by_government_health_insurance_medicaid_number",
  "covered_by_government_health_insurance_medicaid_margin_of_error",
  "covered_by_government_health_insurance_medicaid_percent",
  "covered_by_government_health_insurance_medicaid_margin_of_error_2",
  "covered_by_government_health_insurance_also_by_private_insurance_number",
  "covered_by_government_health_insurance_also_by_private_insurance_margin_of_error",
  "covered_by_government_health_insurance_also_by_private_insurance_percent",
  "covered_by_government_health_insurance_also_by_private_insurance_margin_of_error_2",
  "covered_by_government_health_insurance_medicare_number",
  "covered_by_government_health_insurance_medicare_margin_of_error",
  "covered_by_government_health_insurance_medicare_percent",
  "covered_by_government_health_insurance_medicare_margin_of_error_2",
  "covered_by_government_health_insurance_medicare_also_by_private_insurance_number",
  "covered_by_government_health_insurance_medicare_also_by_private_insurance_margin_of_error",
  "covered_by_government_health_insurance_medicare_also_by_private_insurance_percent",
  "covered_by_government_health_insurance_medicare_also_by_private_insurance_margin_of_error_2",
  "covered_by_government_health_insurance_medicare_also_by_medicaid_number",
  "covered_by_government_health_insurance_medicare_also_by_medicaid_margin_of_error",
  "covered_by_government_health_insurance_medicare_also_by_medicaid_percent",
  "covered_by_government_health_insurance_medicare_also_by_medicaid_margin_of_error_2",
  "covered_by_government_health_insurance_va_care_number",
  "covered_by_government_health_insurance_va_care_margin_of_error",
  "covered_by_government_health_insurance_va_care_percent",
  "covered_by_government_health_insurance_va_care_margin_of_error_2",
  "uninsured_number",
  "uninsured_margin_of_error",
  "uninsured_percent",
  "uninsured_margin_of_error_2"
)

texas <- read_csv("texas 2016-2024.csv", skip = 3, col_names = new_headers)

texas <- texas %>%
  slice(-(1:2))

texas <- texas %>%
  slice(-(41:45))

texas <- texas %>%
  mutate(
    # If 'texas_year' is "Texas", make it NA (to fill later)
    texas_year = ifelse(tolower(texas_year) == "texas", NA, texas_year),
    texas_year = na_if(texas_year, "")
  ) %>%
  # Fill down the previous non-missing year
  fill(texas_year, .direction = "down")

texas <- texas %>%
  mutate(texas_year = as.numeric(texas_year))

texas <- texas %>%
  mutate(characteristic = na_if(characteristic, "")) %>%
  fill(characteristic, .direction = "down")

write_csv(texas, "texas_clean_ready.csv")
```

```{r texas insurance analysis}
library(readr)
library(dplyr)
library(stringr)
library(janitor)
library(ggplot2)
library(tidyr)

texas <- read_csv("texas_clean_headers_fixed.csv")

texas <- texas %>%
  clean_names() %>%
  select(where(~ !all(is.na(.x)))) %>%   
  filter(!if_all(everything(), is.na))   

texas <- texas %>%
  mutate(across(where(is.character), ~ str_replace_all(.x, "[^0-9\\.]", ""))) %>%
  mutate(across(
    where(~ all(grepl("^\\d*(\\.\\d+)?$", ., ignore.case = TRUE) | is.na(.))),
    ~ as.numeric(.)
  ))

texas_clean <- texas %>%
  select(
    year = texas_year,
    characteristic,
    total = total_number,
    private = covered_by_private_health_insurance_number,
    public = covered_by_government_health_insurance_number,
    uninsured = uninsured_number,
    private_percent = covered_by_private_health_insurance_percent,
    public_percent = covered_by_government_health_insurance_percent,
    uninsured_percent = uninsured_percent
  ) %>%
  mutate(year = as.numeric(year)) %>%
  drop_na(year)

```

```{r insurance analysis}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(scales)

# 1. Load cleaned data
texas <- read_csv("texas_clean_ready.csv")

# 2. Keep only the "All persons"/"All people" rows (state-level totals)
texas_all <- texas %>%
  filter(str_detect(tolower(characteristic), "all"))

# 3. Compute coverage shares
texas_all <- texas_all %>%
  mutate(
    private_share = covered_by_private_health_insurance_number / total_number,
    public_share  = covered_by_government_health_insurance_number / total_number,
    uninsured_share = uninsured_number / total_number
  )

# 4. Check coverage trends
ggplot(texas_all, aes(x = texas_year)) +
  # Highlight 2019 background
  annotate("rect", xmin = 2018.5, xmax = 2019.5,
           ymin = -Inf, ymax = Inf,
           alpha = 0.15, fill = "red") +

  # Lines for each coverage type
  geom_line(aes(y = private_share, color = "Private"), size = 1.2) +
  geom_line(aes(y = public_share, color = "Public"), size = 1.2) +
  geom_line(aes(y = uninsured_share, color = "Uninsured"), size = 1.2) +

  # Add points for all years
  geom_point(aes(y = private_share, color = "Private"), size = 2) +
  geom_point(aes(y = public_share, color = "Public"), size = 2) +
  geom_point(aes(y = uninsured_share, color = "Uninsured"), size = 2) +

  # Add value labels for 2019
  geom_text(
    data = subset(texas_all, texas_year == 2019),
    aes(y = private_share, label = scales::percent(private_share, accuracy = 0.1)),
    vjust = -1.0, color = "#1f78b4", fontface = "bold", size = 4
  ) +
  geom_text(
    data = subset(texas_all, texas_year == 2019),
    aes(y = public_share, label = scales::percent(public_share, accuracy = 0.1)),
    vjust = -1.0, color = "#33a02c", fontface = "bold", size = 4
  ) +
  geom_text(
    data = subset(texas_all, texas_year == 2019),
    aes(y = uninsured_share, label = scales::percent(uninsured_share, accuracy = 0.1)),
    vjust = -1.0, color = "#e31a1c", fontface = "bold", size = 4
  ) +

  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    title = "Texas Health Insurance by Type (2016–2024)",
    x = "Year", y = "Share of Total Population",
    color = "Insurance Type"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )


# 5. Relationship between private and public coverage
ggplot(texas_all, aes(x = private_share, y = public_share)) +
  geom_point(size = 3, color = "#2c7fb8") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred") +
  labs(
    title = "Substitution Between Private and Public Coverage",
    x = "Private Insurance Share", y = "Public Insurance Share"
  ) +
  theme_minimal(base_size = 13)

# 6. Simple regression: Does lower private coverage predict higher public coverage?
model_afford <- lm(public_share ~ private_share + texas_year, data = texas_all)
summary(model_afford)

# 7. Regression: Are uninsured rates explained by private & public shares?
model_uninsured <- lm(uninsured_share ~ private_share + public_share + texas_year, data = texas_all)
summary(model_uninsured)

# 8. Optional: visualize uninsured vs. public/private trends
ggplot(texas_all, aes(x = private_share, y = uninsured_share)) +
  geom_point(size = 3, color = "#ef6548") +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  labs(
    title = "Private Coverage vs. Uninsured Rate (Texas)",
    x = "Private Insurance Share", y = "Uninsured Share"
  ) +
  theme_minimal(base_size = 13)

```

```{r self-employed texas}
class_of_worker_2019 <- read.csv("data/ACSCP1Y2019.CP03-Data.csv")
class_of_worker_2024 <- read.csv("data/ACSCP1Y2024.CP03-Data.csv")
class_of_worker_2019 <- class_of_worker_2019[-1, ]
class_of_worker_2024 <- class_of_worker_2024[-1, ]
cols_2024 <- c(
  "CP03_2023_049E", 
  "CP03_2022_049E", 
  "CP03_2024_049E", 
  "CP03_2021_049E",
  "CP03_2020_049E"
)
cols_2019 <- c(
  "CP03_2019_049E", 
  "CP03_2018_049E", 
  "CP03_2017_049E", 
  "CP03_2016_049E"
)
subset_2019 <- class_of_worker_2019[, c("GEO_ID", "NAME", cols_2019)]
subset_2024 <- class_of_worker_2024[, c("GEO_ID", "NAME", cols_2024)]
subset_2019[, cols_2019] <- lapply(subset_2019[, cols_2019], \(x) as.numeric(gsub("\\*", NA, x)))
subset_2024[, cols_2024] <- lapply(subset_2024[, cols_2024], \(x) as.numeric(gsub("\\*", NA, x)))

selfemp_long_2019 <- subset_2019 %>%
  pivot_longer(
    cols = starts_with("CP03_"),
    names_to = "Variable",
    values_to = "SelfEmpRate"
  ) %>%
  mutate(
    Year = as.numeric(sub("CP03_(\\d{4})_049E", "\\1", Variable))
  ) %>%
  select(GEO_ID, NAME, Year, SelfEmpRate)

selfemp_long_2024 <- subset_2024 %>%
  pivot_longer(
    cols = starts_with("CP03_"),
    names_to = "Variable",
    values_to = "SelfEmpRate"
  ) %>%
  mutate(
    Year = as.numeric(sub("CP03_(\\d{4})_049E", "\\1", Variable))
  ) %>%
  select(GEO_ID, NAME, Year, SelfEmpRate)

selfemp_all <- bind_rows(selfemp_long_2019, selfemp_long_2024)

selfemp_all <- selfemp_all %>%
  select(Year, SelfEmpRate) %>%
  arrange(Year) %>% 
  distinct()  

selfemp_all <- selfemp_all %>%
  rename(texas_year = Year)

merged_texas <- texas_all %>%
  left_join(selfemp_all, by = "texas_year")

scale_factor <- max(merged_texas$SelfEmpRate, na.rm = TRUE) /
                max(merged_texas$uninsured_share, na.rm = TRUE)

ggplot(merged_texas, aes(x = texas_year)) +  # use merged_texas, not texas_all
  # Highlight 2019 background
  annotate("rect", xmin = 2018.5, xmax = 2019.5,
           ymin = -Inf, ymax = Inf,
           alpha = 0.15, fill = "red") +

  # Lines for each coverage type
  geom_line(aes(y = private_share, color = "Private"), size = 1.2, na.rm = TRUE) +
  geom_line(aes(y = public_share, color = "Public"), size = 1.2, na.rm = TRUE) +
  geom_line(aes(y = uninsured_share, color = "Uninsured"), size = 1.2, na.rm = TRUE) +

  # Add points
  geom_point(aes(y = private_share, color = "Private"), size = 2) +
  geom_point(aes(y = public_share, color = "Public"), size = 2) +
  geom_point(aes(y = uninsured_share, color = "Uninsured"), size = 2) +
  geom_line(
    aes(y = SelfEmpRate / scale_factor, color = "Self-Employment Rate"),
    size = 1.3, linetype = "dashed", na.rm = TRUE
  ) +
  geom_point(
    aes(y = SelfEmpRate / scale_factor, color = "Self-Employment Rate"),
    size = 2, na.rm = TRUE
  ) +

  scale_y_continuous(
    labels = percent_format(accuracy = 1),
    sec.axis = sec_axis(~ . * scale_factor, name = "Self-Employment Rate (%)")
  ) +
  labs(
    title = "Texas Health Insurance vs. Self-Employment (2016–2024)",
    subtitle = "Dashed line shows self-employment rate; red highlight = 2019",
    x = "Year", y = "Share of Total Population",
    color = "Variable"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )

model_selfemp_uninsured <- lm(uninsured_share ~ SelfEmpRate + texas_year, data = merged_texas)
summary(model_selfemp_uninsured)

```

```{r insurance analysis 2019}
library(readr)
library(dplyr)
library(broom)

texas <- read_csv("texas_clean_ready.csv")

texas_all <- texas %>%
  filter(str_detect(tolower(characteristic), "all"))

texas_all <- texas_all %>%
  mutate(
    uninsured_share = uninsured_number / total_number,
    private_share = covered_by_private_health_insurance_number / total_number,
    public_share = covered_by_government_health_insurance_number / total_number,
    year_2019 = ifelse(texas_year == 2019, 1, 0)
  )

model_2019 <- lm(uninsured_share ~ year_2019 + texas_year, data = texas_all)
summary(model_2019)
tidy(model_2019)
```