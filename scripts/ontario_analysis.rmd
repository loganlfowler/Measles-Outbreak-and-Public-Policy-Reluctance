---
title: "ontario_analysis"
author: "Miriam Zhou"
date: "2025-12-13"
output: html_document
---

```{r ontario canada outbreak vs. measles vax rate}
library(dplyr)
#https://www.publichealthontario.ca/en/data-and-analysis/infectious-disease/immunization-tool
ont_vax_health_unit <- read.csv("data/Coverage_by_milestone_2013_24.csv")

ont_measles_vax_healthunit <- ont_vax_health_unit %>%
  filter(Antigen == "Measles")

# https://www.publichealthontario.ca/-/media/Documents/M/24/measles-ontario-epi-summary.pdf?rev=da3ffec26cc0471f83ed9de3ca356e1c&sc_lang=en
ont_measles_cases <- read.csv("data/ontario_measles_trend_2013_2025.csv")

# https://www.publichealthontario.ca/en/Data-and-Analysis/Infectious-Disease/Immunization-Tool
ont_measles_vax_province <- read.csv("data/Immunization coverage for selected antigens and age milestones in Ontario, 2013-14 to 2023-24 school year.csv") 

vax_summary <- ont_measles_vax_province %>%
  filter(grepl("Measles", Indicator)) %>%
  mutate(Year = as.numeric(substr(schoolyr, 1, 4)) + 1) %>% # convert "2013–14" → 2014
  group_by(Year) %>%
  summarise(Mean_Coverage = mean(Sum.of.coverage, na.rm = TRUE))

cases_summary <- ont_measles_cases %>%
  select(Year, Total.Cases) %>%
  mutate(Total.Cases = as.numeric(Total.Cases))

merged <- full_join(vax_summary, cases_summary, by = "Year")

scale_factor <- max(merged$Total.Cases, na.rm = TRUE) / max(merged$Mean_Coverage, na.rm = TRUE)

ggplot(merged, aes(x = Year)) +
  geom_line(aes(y = Mean_Coverage), color = "steelblue", size = 1.2) +
  geom_point(aes(y = Mean_Coverage), color = "steelblue", size = 2) +
  geom_line(aes(y = Total.Cases / scale_factor), color = "firebrick", size = 1.2) +
  geom_point(aes(y = Total.Cases / scale_factor), color = "firebrick", size = 2) +
  geom_text(
    data = merged,
    aes(y = Mean_Coverage, label = sprintf("%.1f%%", Mean_Coverage)),
    vjust = -1.5, color = "steelblue", size = 3.5
  ) +
  geom_text(
    data = merged,
    aes(y = Total.Cases / scale_factor,
        label = Total.Cases),
    vjust = -1.5, color = "firebrick", size = 3.5
  ) +
  annotate("rect", xmin = 2020.4, xmax = 2021.5,
           ymin = -Inf, ymax = Inf,
           alpha = 0.15, fill = "purple") +
  scale_y_continuous(
    name = "Mean Measles Vaccination Coverage (%)",
    sec.axis = sec_axis(~ . * scale_factor, name = "Total Reported Measles Cases")
  ) +
  scale_x_continuous(breaks = seq(2013, 2025, 1)) +
  labs(
    title = "Ontario Measles Vaccination Coverage vs. Cases",
    subtitle = "Blue: vaccination coverage (age 7 & 17 combined) | Red: total measles cases",
    x = "Year"
  ) +
  coord_cartesian(clip = "off", ylim = c(0, 105)) + 
  theme_minimal(base_size = 13) +
  theme(
    axis.title.y.left = element_text(color = "steelblue"),
    axis.text.y.left = element_text(color = "steelblue"),
    axis.title.y.right = element_text(color = "firebrick"),
    axis.text.y.right = element_text(color = "firebrick"),
    panel.grid.minor = element_blank()
  )

```

```{r travel burden ontario}
library(ggplot2)
travel_raw <- read_csv("data/travel-burden-hospital-care-canada-data-tables-ont.csv", skip=1) 

travel_on %>%
  mutate(
    Value = as.numeric(Value), 
    Burden_Score = factor(
      Burden_Score,
      levels = 1:5,
      labels = c("Very low", "Low", "Moderate", "High", "Very high")
    )
  ) %>%
  ggplot(aes(
    x = `Rural/remote versus urban`,
    y = Value,
    fill = Burden_Score
  )) +
  geom_col(position = "fill") +
 
  labs(
    title = "Travel Burden for Hospital Care (2018–2023)",
    subtitle = "Percent of hospitalizations by travel burden category and rurality",
    x = "Rurality Category",
    y = "Share of Hospitalizations",
    fill = "Travel Burden Level"
  ) +
  theme_minimal(base_size = 14)
```

```{r COVID vax vs. measles vax}
# https://health-infobase.canada.ca/covid-19/vaccination-coverage
library(dplyr)
library(ggplot2)
covid_vax_canada <- read.csv("data/vaccination-coverage-map.csv")
covid_on <- covid_vax_canada %>%
  filter(prename == "Ontario") %>%
  select(week_end, prop5plus_fully, prop5plus_atleast1dose) %>%
  mutate(year = lubridate::year(week_end)) %>%
  group_by(year) %>%
  summarize(
    covid_vax_full = mean(prop5plus_fully, na.rm = TRUE)
  )

merged_all <- merged %>%
  left_join(covid_on, by = c("Year" = "year"))

scale_factor <- max(merged_all$Total.Cases, na.rm = TRUE) / max(merged_all$Mean_Coverage, na.rm = TRUE)

plot_data <- merged_all %>%
  mutate(    
    measles_cases_scaled = Total.Cases / scale_factor
  ) %>%
  select(Year, Mean_Coverage, measles_cases_scaled, covid_vax_full) %>%
  tidyr::pivot_longer(
    cols = -Year,
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  mutate(
    Variable = factor(
      Variable,
      levels = c("Mean_Coverage", "covid_vax_full", "measles_cases_scaled"),
      labels = c("Measles Coverage (%)", "COVID-19 Coverage (%)", "Measles Cases (scaled)")
    )
  )

ggplot(plot_data, aes(x = Year, y = Value, color = Variable, linetype = Variable)) +
  geom_line(size = 1.3, na.rm = TRUE) +
  geom_point(size = 2, na.rm = TRUE) +
  geom_text(
    data = subset(merged_all, !is.na(Mean_Coverage)),
    aes(x = Year, y = Mean_Coverage, label = sprintf("%.1f%%", Mean_Coverage)),
    vjust = 1.5, color = "steelblue", size = 3.5, inherit.aes = FALSE
  ) +
  geom_text(
    data = subset(merged_all, !is.na(covid_vax_full)),
    aes(x = Year, y = covid_vax_full, label = sprintf("%.1f%%", covid_vax_full)),
    vjust = -1.2, color = "darkgreen", size = 3.5, inherit.aes = FALSE
  ) +
  geom_text(
    data = subset(merged_all, !is.na(Total.Cases)),
    aes(x = Year, y = Total.Cases / scale_factor, label = Total.Cases),
    vjust = -1.2, color = "firebrick", size = 3.5, inherit.aes = FALSE
  ) +
  scale_color_manual(values = c("steelblue", "darkgreen", "firebrick")) +
  scale_linetype_manual(values = c("solid", "dashed", "solid")) +
  scale_x_continuous(breaks = seq(2013, 2025, 1)) +
  coord_cartesian(ylim = c(0, 105), clip = "off") +
  labs(
    title = "Ontario Measles Coverage, Cases, and COVID-19 Vaccination",
    x = "Year"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.y = element_blank()
  )
```