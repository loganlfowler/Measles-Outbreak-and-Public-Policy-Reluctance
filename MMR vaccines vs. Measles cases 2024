---
title: "Measles Vaccination Coverage and Case Analysis"
author: "Miriam Zhou"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(ggplot2)
library(dplyr)
library(lmtest)
library(ggrepel)
library(sandwich)
library(readxl) # for Excel data

vacc <- read.csv("data/X2009_2024_overall.csv")
cases_us <- read_excel("data/403-table-web-reporting-data-us-only.xlsx", skip = 2)
state_2024 <- read.csv("data/X2024_state_cases.csv")

vacc_mmr <- subset(vacc, Vaccine.Exemption == "MMR")
vacc_mmr$estimate_num <- as.numeric(vacc_mmr$Estimate....)
vacc_mmr$year <- as.numeric(substr(vacc_mmr$School.Year, 1, 4))

vacc_mmr <- vacc_mmr[, c("Geography", "year", "estimate_num")]
colnames(vacc_mmr) <- c("Location", "year", "MMR_Coverage")

# Filter for national-level data (United States only)
vacc_us <- subset(vacc_mmr, Location == "United States")
cases_us <- cases_us[, c("Year", "Total confirmed measles cases")]
colnames(cases_us) <- c("year", "Cases")

merged_us <- merge(cases_us, vacc_us, by = "year")

# 2024 vaccination data
vacc_2024 <- subset(vacc, school_year == "2023-24")[, c("geography", "estimate....")]
colnames(vacc_2024) <- c("Location", "MMR_Coverage")
data_2024 <- merge(state_2024, vacc_2024, by = "Location")
outliers <- data_2024 %>% filter(Cases > 20)

ggplot(data_2024, aes(x = MMR_Coverage, y = Cases)) +
  geom_point(color = "blue", size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "darkblue") +
  geom_text_repel(data = outliers, aes(label = Location), color = "red", size = 3.5) +
  labs(title = "State-level MMR Coverage vs. Measles Cases (2024)",
       x = "MMR Coverage (%)",
       y = "Confirmed Measles Cases") +
  theme_minimal()
